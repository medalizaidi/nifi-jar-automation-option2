version: 2.1
# ===========================================
# NiFi Rollback Pipeline with Backup Selection
# ===========================================

# ===========================================
# PIPELINE PARAMETERS
# ===========================================
parameters:
  backup-date:
    type: string
    default: ""
    description: "Backup date (YYYY-MM-DD)"
  
  backup-time:
    type: string
    default: ""
    description: "Backup time (HH-MM-JST or HH-MM-UTC)"
  
  automated:
    type: boolean
    default: false
    description: "Automated rollback (uploads directly to NiFi)"

# ===========================================
# EXECUTORS
# ===========================================
executors:
  python-executor:
    docker:
      - image: cimg/python:3.11
    resource_class: small

# ===========================================
# JOBS
# ===========================================
jobs:
  list-available-backups:
    executor: python-executor
    steps:
      - checkout
      - run:
          name: Install dependencies
          command: pip install PyGithub
      - run:
          name: List all backups with selection instructions
          command: |
            python scripts/rollback_nifi_automated.py --list-only
            echo ""
            echo "============================================================"
            echo "   TO ROLLBACK TO A SPECIFIC BACKUP:"
            echo "============================================================"
            echo ""
            echo "1. Go to CircleCI ‚Üí Projects ‚Üí Your Project"
            echo "2. Click 'Trigger Pipeline' (blue button top-right)"
            echo "3. Branch: main"
            echo "4. Add Parameters:"
            echo "   - Name: backup-date"
            echo "     Type: string"
            echo "     Value: YYYY-MM-DD (from list above)"
            echo ""
            echo "   - Name: backup-time"
            echo "     Type: string"
            echo "     Value: HH-MM-JST (from list above)"
            echo ""
            echo "   - Name: automated (optional)"
            echo "     Type: boolean"
            echo "     Value: true (for automatic upload to NiFi)"
            echo "            false (for manual completion - SAFER)"
            echo ""
            echo "5. Click 'Trigger Pipeline'"
            echo "6. Approve when prompted"
            echo ""
            echo "Example:"
            echo "  backup-date: 2026-01-27"
            echo "  backup-time: 12-00-JST"
            echo "  automated: false"
            echo ""
            echo "============================================================"

  validate-parameters:
    executor: python-executor
    parameters:
      backup-date:
        type: string
      backup-time:
        type: string
    steps:
      - run:
          name: Validate rollback parameters
          command: |
            echo "========================================"
            echo "    VALIDATING PARAMETERS"
            echo "========================================"
            echo ""
            
            BACKUP_DATE="<< parameters.backup-date >>"
            BACKUP_TIME="<< parameters.backup-time >>"
            
            echo "Backup Date: $BACKUP_DATE"
            echo "Backup Time: $BACKUP_TIME"
            echo ""
            
            if ! echo "$BACKUP_DATE" | grep -qE '^[0-9]{4}-[0-9]{2}-[0-9]{2}$'; then
              echo "‚ùå Invalid date format: $BACKUP_DATE"
              exit 1
            fi
            
            if ! echo "$BACKUP_TIME" | grep -qE '^[0-9]{2}-[0-9]{2}-(UTC|JST)$'; then
              echo "‚ùå Invalid time format: $BACKUP_TIME"
              echo "   Expected: HH-MM-JST or HH-MM-UTC (e.g., 12-00-JST)"
              exit 1
            fi
            
            echo "‚úÖ Parameters are valid"

  display-rollback-info:
    executor: python-executor
    parameters:
      backup-date:
        type: string
      backup-time:
        type: string
      automated:
        type: boolean
    steps:
      - run:
          name: Display rollback information for approval
          command: |
            echo "========================================"
            echo "   ROLLBACK APPROVAL REQUIRED"
            echo "========================================"
            echo ""
            echo "You are about to rollback NiFi to:"
            echo ""
            echo "  üìÖ Date: << parameters.backup-date >>"
            echo "  üïê Time: << parameters.backup-time >>"
            echo "  ü§ñ Mode: << parameters.automated >>"
            echo ""
            if [ "<< parameters.automated >>" = "true" ]; then
              echo "‚ö†Ô∏è  AUTOMATED MODE - DESTRUCTIVE!"
              echo ""
              echo "This will:"
              echo "  1. Stop all processors"
              echo "  2. DELETE all existing components"
              echo "  3. Upload the backup automatically"
              echo "  4. Leave processors stopped"
              echo ""
              echo "üî¥ THIS CANNOT BE UNDONE!"
            else
              echo "‚úÖ MANUAL MODE - SAFER"
              echo ""
              echo "This will:"
              echo "  1. Download the backup from GitHub"
              echo "  2. Save to CircleCI artifacts"
              echo "  3. You complete the rollback in NiFi UI"
              echo ""
              echo "üü¢ You have full control"
            fi
            echo ""
            echo "========================================"
            echo ""
            echo "Review the information above carefully."
            echo "Click 'Approve' to proceed."
            echo ""
            echo "========================================"

  nifi-rollback-manual:
    executor: python-executor
    parameters:
      backup-date:
        type: string
      backup-time:
        type: string
    steps:
      - checkout
      - run:
          name: Install dependencies
          command: pip install PyGithub requests
      - run:
          name: Prepare rollback (manual completion)
          command: |
            export BACKUP_DATE="<< parameters.backup-date >>"
            export BACKUP_TIME="<< parameters.backup-time >>"
            python scripts/rollback_nifi.py
      - store_artifacts:
          path: /tmp
          destination: rollback-files

  nifi-rollback-automated:
    executor: python-executor
    parameters:
      backup-date:
        type: string
      backup-time:
        type: string
    steps:
      - checkout
      - run:
          name: Display WARNING
          command: |
            echo "========================================"
            echo "       ‚ö†Ô∏è  AUTOMATED ROLLBACK ‚ö†Ô∏è"
            echo "========================================"
            echo ""
            echo "This will AUTOMATICALLY:"
            echo "  1. Stop all NiFi processors"
            echo "  2. Delete ALL existing flow components"
            echo "  3. Upload the backup"
            echo ""
            echo "This is DESTRUCTIVE and IRREVERSIBLE!"
            echo ""
            echo "========================================"
      - run:
          name: Verify environment variables
          command: |
            MISSING=""
            
            if [ -z "${NIFI_HOST}" ]; then
              echo "‚ùå NIFI_HOST not set"
              MISSING="yes"
            fi
            
            if [ -z "${NIFI_USERNAME}" ]; then
              echo "‚ùå NIFI_USERNAME not set"
              MISSING="yes"
            fi
            
            if [ -z "${NIFI_PASSWORD}" ]; then
              echo "‚ùå NIFI_PASSWORD not set"
              MISSING="yes"
            fi
            
            if [ -z "${GITHUB_TOKEN}" ]; then
              echo "‚ùå GITHUB_TOKEN not set"
              MISSING="yes"
            fi
            
            if [ -n "$MISSING" ]; then
              echo "‚ùå Missing required variables"
              exit 1
            fi
            
            echo "‚úÖ All variables set"
      - run:
          name: Install dependencies
          command: pip install PyGithub requests
      - run:
          name: Execute automated rollback
          command: |
            export BACKUP_DATE="<< parameters.backup-date >>"
            export BACKUP_TIME="<< parameters.backup-time >>"
            export AUTO_CONFIRM="true"
            python scripts/rollback_nifi_automated.py
      - store_artifacts:
          path: /tmp
          destination: rollback-files
      - run:
          name: Rollback summary
          when: on_success
          command: |
            echo ""
            echo "========================================"
            echo "   ‚úÖ AUTOMATED ROLLBACK COMPLETE"
            echo "========================================"
            echo ""
            echo "The flow has been restored from:"
            echo "  << parameters.backup-date >> << parameters.backup-time >>"
            echo ""
            echo "‚ö†Ô∏è  IMPORTANT: Start processors manually"
            echo ""
            echo "Go to NiFi UI and:"
            echo "  1. Verify the flow looks correct"
            echo "  2. Start processors"
            echo "  3. Monitor for issues"
            echo ""
            echo "========================================"

# ===========================================
# WORKFLOWS
# ===========================================
workflows:
  version: 2

  # List backups (no parameters)
  list-backups:
    when:
      and:
        - equal: [ "", << pipeline.parameters.backup-date >> ]
        - equal: [ "", << pipeline.parameters.backup-time >> ]
    jobs:
      - list-available-backups:
          context:
            - github-context

  # Manual rollback (requires UI completion)
  manual-rollback:
    when:
      and:
        - << pipeline.parameters.backup-date >>
        - not: << pipeline.parameters.automated >>
    jobs:
      - validate-parameters:
          backup-date: << pipeline.parameters.backup-date >>
          backup-time: << pipeline.parameters.backup-time >>
      
      - display-rollback-info:
          requires:
            - validate-parameters
          backup-date: << pipeline.parameters.backup-date >>
          backup-time: << pipeline.parameters.backup-time >>
          automated: false
      
      - hold-for-rollback-approval:
          type: approval
          requires:
            - display-rollback-info
          filters:
            branches:
              only:
                - main
      
      - nifi-rollback-manual:
          requires:
            - hold-for-rollback-approval
          backup-date: << pipeline.parameters.backup-date >>
          backup-time: << pipeline.parameters.backup-time >>
          context:
            - nifi-context
            - github-context

  # Automated rollback (uploads directly to NiFi)
  automated-rollback:
    when:
      and:
        - << pipeline.parameters.backup-date >>
        - << pipeline.parameters.automated >>
    jobs:
      - validate-parameters:
          backup-date: << pipeline.parameters.backup-date >>
          backup-time: << pipeline.parameters.backup-time >>
      
      - display-rollback-info:
          requires:
            - validate-parameters
          backup-date: << pipeline.parameters.backup-date >>
          backup-time: << pipeline.parameters.backup-time >>
          automated: true
      
      - hold-for-automated-rollback:
          type: approval
          requires:
            - display-rollback-info
          filters:
            branches:
              only:
                - main
      
      - nifi-rollback-automated:
          requires:
            - hold-for-automated-rollback
          backup-date: << pipeline.parameters.backup-date >>
          backup-time: << pipeline.parameters.backup-time >>
          context:
            - nifi-context
            - github-context