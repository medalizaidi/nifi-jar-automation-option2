version: 2.1
# ===========================================
# NiFi Rollback Pipeline
# ===========================================

# ===========================================
# PIPELINE PARAMETERS
# ===========================================
parameters:
  backup-date:
    type: string
    default: ""
    description: "Backup date (YYYY-MM-DD)"
  
  backup-time:
    type: string
    default: ""
    description: "Backup time (HH-MM-UTC)"
  
  automated:
    type: boolean
    default: false
    description: "Automated rollback (uploads directly to NiFi)"

# ===========================================
# EXECUTORS
# ===========================================
executors:
  python-executor:
    docker:
      - image: cimg/python:3.11
    resource_class: small

# ===========================================
# JOBS
# ===========================================
jobs:
  list-available-backups:
    executor: python-executor
    steps:
      - checkout
      - run:
          name: Install dependencies
          command: pip install PyGithub
      - run:
          name: List all backups
          command: python scripts/rollback_nifi_automated.py --list-only

  validate-parameters:
    executor: python-executor
    parameters:
      backup-date:
        type: string
      backup-time:
        type: string
    steps:
      - run:
          name: Validate rollback parameters
          command: |
            echo "========================================"
            echo "    VALIDATING PARAMETERS"
            echo "========================================"
            echo ""
            
            BACKUP_DATE="<< parameters.backup-date >>"
            BACKUP_TIME="<< parameters.backup-time >>"
            
            echo "Backup Date: $BACKUP_DATE"
            echo "Backup Time: $BACKUP_TIME"
            echo ""
            
            if ! echo "$BACKUP_DATE" | grep -qE '^[0-9]{4}-[0-9]{2}-[0-9]{2}$'; then
              echo "❌ Invalid date format: $BACKUP_DATE"
              exit 1
            fi
            
            if ! echo "$BACKUP_TIME" | grep -qE '^[0-9]{2}-[0-9]{2}-UTC$'; then
              echo "❌ Invalid time format: $BACKUP_TIME"
              exit 1
            fi
            
            echo "✅ Parameters are valid"

  nifi-rollback-manual:
    executor: python-executor
    parameters:
      backup-date:
        type: string
      backup-time:
        type: string
    steps:
      - checkout
      - run:
          name: Install dependencies
          command: pip install PyGithub requests
      - run:
          name: Prepare rollback (manual completion)
          command: |
            export BACKUP_DATE="<< parameters.backup-date >>"
            export BACKUP_TIME="<< parameters.backup-time >>"
            python scripts/rollback_nifi.py
      - store_artifacts:
          path: /tmp
          destination: rollback-files

  nifi-rollback-automated:
    executor: python-executor
    parameters:
      backup-date:
        type: string
      backup-time:
        type: string
    steps:
      - checkout
      - run:
          name: Display WARNING
          command: |
            echo "========================================"
            echo "       ⚠️  AUTOMATED ROLLBACK ⚠️"
            echo "========================================"
            echo ""
            echo "This will AUTOMATICALLY:"
            echo "  1. Stop all NiFi processors"
            echo "  2. Delete ALL existing flow components"
            echo "  3. Upload the backup"
            echo ""
            echo "This is DESTRUCTIVE and IRREVERSIBLE!"
            echo ""
            echo "========================================"
      - run:
          name: Verify environment variables
          command: |
            MISSING=""
            
            if [ -z "${NIFI_HOST}" ]; then
              echo "❌ NIFI_HOST not set"
              MISSING="yes"
            fi
            
            if [ -z "${NIFI_USERNAME}" ]; then
              echo "❌ NIFI_USERNAME not set"
              MISSING="yes"
            fi
            
            if [ -z "${NIFI_PASSWORD}" ]; then
              echo "❌ NIFI_PASSWORD not set"
              MISSING="yes"
            fi
            
            if [ -z "${GITHUB_TOKEN}" ]; then
              echo "❌ GITHUB_TOKEN not set"
              MISSING="yes"
            fi
            
            if [ -n "$MISSING" ]; then
              echo "❌ Missing required variables"
              exit 1
            fi
            
            echo "✅ All variables set"
      - run:
          name: Install dependencies
          command: pip install PyGithub requests
      - run:
          name: Execute automated rollback
          command: |
            export BACKUP_DATE="<< parameters.backup-date >>"
            export BACKUP_TIME="<< parameters.backup-time >>"
            export AUTO_CONFIRM="true"
            python scripts/rollback_nifi_automated.py
      - store_artifacts:
          path: /tmp
          destination: rollback-files
      - run:
          name: Rollback summary
          when: on_success
          command: |
            echo ""
            echo "========================================"
            echo "   ✅ AUTOMATED ROLLBACK COMPLETE"
            echo "========================================"
            echo ""
            echo "The flow has been restored from:"
            echo "  << parameters.backup-date >> << parameters.backup-time >>"
            echo ""
            echo "⚠️  IMPORTANT: Start processors manually"
            echo ""
            echo "Go to NiFi UI and:"
            echo "  1. Verify the flow looks correct"
            echo "  2. Start processors"
            echo "  3. Monitor for issues"
            echo ""
            echo "========================================"

# ===========================================
# WORKFLOWS
# ===========================================
workflows:
  version: 2

  # List backups (no parameters)
  list-backups:
    when:
      and:
        - equal: [ "", << pipeline.parameters.backup-date >> ]
        - equal: [ "", << pipeline.parameters.backup-time >> ]
    jobs:
      - list-available-backups:
          context:
            - github-context

  # Manual rollback (requires UI completion)
  manual-rollback:
    when:
      and:
        - << pipeline.parameters.backup-date >>
        - not: << pipeline.parameters.automated >>
    jobs:
      - validate-parameters:
          backup-date: << pipeline.parameters.backup-date >>
          backup-time: << pipeline.parameters.backup-time >>
      
      - hold-for-rollback-approval:
          type: approval
          requires:
            - validate-parameters
          filters:
            branches:
              only:
                - main
      
      - nifi-rollback-manual:
          requires:
            - hold-for-rollback-approval
          backup-date: << pipeline.parameters.backup-date >>
          backup-time: << pipeline.parameters.backup-time >>
          context:
            - nifi-context
            - github-context

  # Automated rollback (uploads directly to NiFi)
  automated-rollback:
    when:
      and:
        - << pipeline.parameters.backup-date >>
        - << pipeline.parameters.automated >>
    jobs:
      - validate-parameters:
          backup-date: << pipeline.parameters.backup-date >>
          backup-time: << pipeline.parameters.backup-time >>
      
      - hold-for-automated-rollback:
          type: approval
          requires:
            - validate-parameters
          filters:
            branches:
              only:
                - main
      
      - nifi-rollback-automated:
          requires:
            - hold-for-automated-rollback
          backup-date: << pipeline.parameters.backup-date >>
          backup-time: << pipeline.parameters.backup-time >>
          context:
            - nifi-context
            - github-context