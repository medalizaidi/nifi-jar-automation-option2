version: 2.1

orbs:
  aws-cli: circleci/aws-cli@4.1

executors:
  python-executor:
    docker:
      - image: cimg/python:3.11
    resource_class: medium
  docker-executor:
    docker:
      - image: cimg/base:current
    resource_class: medium

jobs:
  # Check if JAR manifest files changed
  check-jar-changes:
    executor: python-executor
    steps:
      - checkout
      - run:
          name: Check if JAR manifests changed
          command: |
            # Check if any JAR manifest files changed
            if git diff --name-only HEAD~1 HEAD | grep -q "workload/.*\/jars\/.*\.json"; then
              echo "✓ JAR manifest files changed - proceeding with pipeline"
              exit 0
            else
              echo "✗ No JAR manifest changes - stopping pipeline"
              circleci-agent step halt
            fi

  scan-jars-and-create-dockerfile-pr:
    executor: python-executor
    steps:
      - checkout
      - run:
          name: Install dependencies
          command: pip install PyGithub requests
      - run:
          name: Scan JARs and create Dockerfile PR
          command: python scripts/scan_jars_and_create_pr.py
          environment:
            DOCKERFILE_PATH: workload/mfx-aggre-data-platform/custom_nifi/Dockerfile
            JARS_FOLDER: workload/mfx-aggre-data-platform/custom_nifi/jars
            TARGET_BRANCH: main
            CIRCLE_PROJECT_USERNAME: medalizaidi
            CIRCLE_PROJECT_REPONAME: nifi-jar-automation-option2
      - store_artifacts:
          path: /tmp/jar-diff-report.json
          destination: jar-diff-report

  check-dockerfile-changes:
    executor: docker-executor
    steps:
      - checkout
      - run:
          name: Check if Dockerfile changed
          command: |
            # Check if Dockerfile was modified in this commit
            if git diff --name-only HEAD~1 HEAD | grep -q "workload/mfx-aggre-data-platform/custom_nifi/Dockerfile"; then
              echo "Dockerfile modified, proceeding with build"
              echo "true" > /tmp/dockerfile-changed.txt
            else
              echo "Dockerfile not modified, skipping build and task definition PR"
              echo "false" > /tmp/dockerfile-changed.txt
            fi
      - persist_to_workspace:
          root: /tmp
          paths:
            - dockerfile-changed.txt

  build-and-push-image:
    executor: docker-executor
    steps:
      - checkout
      - attach_workspace:
          at: /tmp
      - run:
          name: Check if should proceed
          command: |
            if [ ! -f /tmp/dockerfile-changed.txt ]; then
              echo "ERROR: dockerfile-changed.txt not found"
              exit 1
            fi
            
            if [ "$(cat /tmp/dockerfile-changed.txt)" != "true" ]; then
              echo "Dockerfile not modified, skipping build"
              circleci-agent step halt
            fi
            
            echo "Dockerfile was modified, proceeding with build"
      - setup_remote_docker:
          version: 20.10.24
          docker_layer_caching: true
      - aws-cli/setup:
          region: AWS_REGION
          aws_access_key_id: AWS_ACCESS_KEY_ID
          aws_secret_access_key: AWS_SECRET_ACCESS_KEY
      - run:
          name: Build and Push to ECR
          command: |
            # Login to ECR
            aws ecr get-login-password --region ${AWS_REGION} | \
              docker login --username AWS --password-stdin \
              ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com
            
            # Build image
            cd workload/mfx-aggre-data-platform/custom_nifi
            IMAGE_TAG="${CIRCLE_SHA1:0:7}"
            ECR_REPO="${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/apache-nifi-with-custom-jars-repo"
            
            docker build -t ${ECR_REPO}:${IMAGE_TAG} .
            docker tag ${ECR_REPO}:${IMAGE_TAG} ${ECR_REPO}:latest
            
            # Push to ECR
            docker push ${ECR_REPO}:${IMAGE_TAG}
            docker push ${ECR_REPO}:latest
            
            # Save tag for next job
            echo "${IMAGE_TAG}" > /tmp/image-tag.txt
      - persist_to_workspace:
          root: /tmp
          paths:
            - image-tag.txt
            - dockerfile-changed.txt

  create-task-definition-pr:
    executor: python-executor
    steps:
      - checkout
      - attach_workspace:
          at: /tmp
      - run:
          name: Check if should proceed
          command: |
            if [ ! -f /tmp/dockerfile-changed.txt ]; then
              echo "ERROR: dockerfile-changed.txt not found"
              exit 1
            fi
            
            if [ "$(cat /tmp/dockerfile-changed.txt)" != "true" ]; then
              echo "Dockerfile not modified, skipping task definition PR"
              circleci-agent step halt
            fi
            
            echo "Dockerfile was modified, proceeding with task definition update"
      - run:
          name: Install dependencies
          command: pip install PyGithub
      - run:
          name: Create PR to update task definition
          command: python scripts/update_task_definition.py
          environment:
            TASK_DEF_PATH: workload/mfx-aggre-data-platform/ecs_task_definition.tf
            TARGET_BRANCH: main
            CIRCLE_PROJECT_USERNAME: medalizaidi
            CIRCLE_PROJECT_REPONAME: nifi-jar-automation-option2

workflows:
  version: 2

  scan-and-build:
    jobs:
      # Step 1: Check if JAR manifests changed (stops pipeline if no changes)
      - check-jar-changes:
          filters:
            branches:
              only: main

      # Step 2: Scan JARs and create Dockerfile PR
      - scan-jars-and-create-dockerfile-pr:
          requires:
            - check-jar-changes
          filters:
            branches:
              only: main
          context:
            - github-context

      # Step 3: Manual approval - requires user to approve before continuing
      - hold-for-approval:
          type: approval
          requires:
            - scan-jars-and-create-dockerfile-pr

      # Step 4: Check if Dockerfile changed
      - check-dockerfile-changes:
          requires:
            - hold-for-approval
          filters:
            branches:
              only: main

      # Step 5: Build and push Docker image
      - build-and-push-image:
          requires:
            - check-dockerfile-changes
          filters:
            branches:
              only: main
          context:
            - aws-context

      # Step 6: Create task definition PR
      - create-task-definition-pr:
          requires:
            - build-and-push-image
          filters:
            branches:
              only: main
          context:
            - github-context
            - aws-context 